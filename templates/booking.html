{% extends "base.html" %}
{% block title %}Book Your Visit - Itihasa{% endblock %}
{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    .booking-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
    }

    .booking-title {
        text-align: center;
        color: #f1683a;
        font-size: 2.5em;
        margin-bottom: 30px;
    }

    .booking-form {
        display: grid;
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        font-weight: 500;
        color: #444;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: 'Poppins', sans-serif;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .submit-btn {
        background-color: #f1683a;
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 20px;
    }

    .submit-btn:hover {
        background-color: #e45728;
    }

    .price-info {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f8f8;
        border-radius: 8px;
        text-align: center;
    }

    .error-message {
        color: #ff4444;
        font-size: 14px;
        margin-top: 5px;
    }

    /* Remove chat widget styles */
    .chat-widget,
    .chat-header,
    .chat-messages,
    .chat-input,
    .message,
    .bot-message,
    .user-message {
        display: none;
    }

    /* Payment Modal Styles */
    .payment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-dialog {
        max-width: 600px;
        margin: 1.75rem auto;
    }

    .modal-content {
        border-radius: 15px;
        border: none;
    }

    .modal-body {
        padding: 25px;
    }

    .payment-methods {
        display: grid;
        gap: 15px;
        margin: 20px 0;
    }

    .payment-form {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-top: 15px;
    }

    .payment-form .form-group {
        margin-bottom: 20px;
    }

    .payment-form input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    .payment-form .row {
        margin: 0 -10px;
    }

    .payment-form .col-6 {
        padding: 0 10px;
    }

    .btn-block {
        width: 100%;
        margin-bottom: 10px;
    }

    .btn-primary {
        background-color: #f1683a;
        border-color: #f1683a;
    }

    .btn-primary:hover {
        background-color: #e45728;
        border-color: #e45728;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    #cardPaymentForm, #upiPaymentForm {
        margin-top: 20px;
    }

    .transaction-details, .transaction-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .spinner {
        margin: 30px auto;
    }

    .success-icon {
        margin: 20px 0;
        display: block;
    }

    /* Fix for modal backdrop */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
    }

    /* Fix for scrolling within modal */
    .modal {
        overflow-y: auto !important;
    }

    .modal-body {
        max-height: calc(100vh - 210px);
        overflow-y: auto;
    }

    /* Video Background Styles */
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }

    .video-background video {
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
    }

    /* Sound Toggle Button */
    .sound-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(241, 104, 58, 0.9);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .sound-toggle:hover {
        background: rgba(241, 104, 58, 1);
    }

    .sound-toggle i {
        color: white;
        font-size: 20px;
    }

    .transaction-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
    }

    .transaction-details p {
        margin: 5px 0;
    }

    .transaction-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: left;
    }

    .transaction-summary p {
        margin: 5px 0;
    }

    .remaining-balance {
        color: #f1683a;
        font-weight: bold;
    }

    /* State and Place Dropdown Styles */
    .state-place-container {
        display: grid;
        gap: 20px;
        margin-bottom: 20px;
    }

    #placeSelect {
        max-height: 300px;
        overflow-y: auto;
    }

    #placeSelect option {
        padding: 8px;
    }

    .booking-form-container {
        position: relative;
        z-index: 2;
    }

    .map-section {
        position: relative;
        z-index: 1;
    }

    .map-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: fit-content;
        position: sticky;
        top: 20px;
        margin-bottom: 30px;
    }

    .map-title {
        color: #f1683a;
        font-size: 1.5em;
        margin-bottom: 15px;
        text-align: center;
    }

    .map-frame {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        margin-bottom: 15px;
        z-index: 1;
    }

    .hotel-recommendations {
        background: #ffffff;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }

    .hotel-section-title {
        color: #f1683a;
        font-size: 1.8em;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
    }

    .no-hotels-message {
        text-align: center;
        color: #666;
        padding: 20px;
        font-style: italic;
    }

    .hotel-cards {
        display: grid;
        gap: 15px;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .hotel-card {
        display: flex;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        gap: 20px;
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
    }

    .hotel-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        background: #ffffff;
    }

    .hotel-image {
        width: 200px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease;
        background: #f0f0f0;
    }

    .hotel-image.loading {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 0.8; }
        100% { opacity: 0.6; }
    }

    .hotel-card:hover .hotel-image {
        transform: scale(1.05);
    }

    .hotel-info {
        flex: 1;
        padding: 10px;
    }

    .hotel-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }

    .hotel-rating {
        color: #f1683a;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .hotel-price {
        font-weight: bold;
        color: #28a745;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .hotel-distance {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .hotel-distance i {
        color: #f1683a;
        font-size: 1em;
    }

    .hotel-features {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .hotel-feature {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        color: #666;
    }

    .package-details {
        background: #ffffff;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
    }

    .package-details:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .package-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1683a;
    }

    .package-title {
        color: #f1683a;
        font-size: 1.8em;
        margin: 0;
        font-weight: 600;
    }

    .package-price-tag {
        background: #f1683a;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 1.2em;
    }

    .package-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .package-info-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
    }

    .package-description {
        font-size: 1.1em;
        line-height: 1.6;
        color: #444;
        margin-bottom: 15px;
    }

    .package-duration {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
        margin-bottom: 15px;
    }

    .package-duration i {
        color: #f1683a;
        font-size: 1.2em;
    }

    .package-features {
        margin-top: 20px;
    }

    .package-features h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2em;
    }

    .package-includes {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .package-includes li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .package-includes li:hover {
        transform: translateX(5px);
        background: #fff5f2;
    }

    .package-includes li:before {
        content: '✓';
        color: #f1683a;
        font-weight: bold;
    }

    .package-highlights {
        background: #fff5f2;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #f1683a;
    }

    .package-highlights h4 {
        color: #f1683a;
        margin-bottom: 15px;
        font-size: 1.2em;
    }

    .highlight-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        color: #444;
    }

    .highlight-item i {
        color: #f1683a;
        font-size: 1.1em;
    }

    .package-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .package-action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .select-package-btn {
        background: #f1683a;
        color: white;
    }

    .select-package-btn:hover {
        background: #e45728;
        transform: translateY(-2px);
    }

    .view-guide-btn {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
    }

    .view-guide-btn:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .guide-profile {
        padding: 20px;
    }
    .guide-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .guide-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        border: 3px solid #f1683a;
    }
    .guide-header h4 {
        color: #f1683a;
        margin: 0;
    }
    .guide-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .guide-info p {
        margin: 8px 0;
        color: #444;
    }
    .guide-description {
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .guide-description h5 {
        color: #333;
        margin-bottom: 10px;
    }
    .guide-description p {
        color: #666;
        line-height: 1.6;
    }

    /* Add this reusable package card component */
    .tour-package-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .tour-package-card:hover {
        transform: translateY(-5px);
    }

    .package-header {
        background: linear-gradient(135deg, #f1683a, #e45728);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .package-title {
        margin: 0;
        font-size: 1.5em;
        font-weight: 600;
    }

    .package-price {
        background: rgba(255,255,255,0.2);
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
    }

    .package-content {
        padding: 20px;
    }

    .package-main-info {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .package-duration, .package-location {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
    }

    .package-description {
        margin-bottom: 20px;
    }

    .package-description h4 {
        color: #f1683a;
        margin-bottom: 10px;
    }

    .package-description p {
        color: #444;
        line-height: 1.6;
    }

    .package-includes {
        margin-bottom: 20px;
    }

    .package-includes h4 {
        color: #f1683a;
        margin-bottom: 15px;
    }

    .package-includes ul {
        list-style: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .package-includes li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .package-includes li i {
        color: #f1683a;
    }

    .package-highlights {
        background: #fff5f2;
        padding: 20px;
        border-radius: 12px;
    }

    .package-highlights h4 {
        color: #f1683a;
        margin-bottom: 15px;
    }

    .highlights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .highlight-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .highlight-item i {
        color: #f1683a;
        font-size: 1.2em;
    }

    .package-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .edit-btn {
        background: #f1683a;
        color: white;
    }

    .delete-btn {
        background: #fff5f5;
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .book-btn {
        background: #f1683a;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .highlights-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .package-includes ul {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Video Background -->
<div class="video-background">
    <video id="bgVideo" autoplay loop playsinline>
        <source src="{{ url_for('static', filename='booking.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<!-- Sound Toggle Button -->
<button class="sound-toggle" onclick="toggleSound()">
    <i class="fas fa-volume-mute" id="soundIcon"></i>
</button>

<div class="booking-container">
    <div class="booking-form-container">
        <h1 class="booking-title">{{ _('Book Your Visit') }}</h1>
        <form class="booking-form" id="bookingForm" onsubmit="return handleBookingSubmit(event)">
            <div class="state-place-container">
            <div class="form-group">
                    <label for="stateSelect">Select State:</label>
                    <select id="stateSelect" name="state" required>
                        <option value="">Choose a State</option>
                        <option value="Agra">Agra (Uttar Pradesh)</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Goa">Goa</option>
                        <option value="Kerala">Kerala</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Jharkhand">Jharkhand</option>
                        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                        <option value="Uttarakhand">Uttarakhand</option>
                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                        <option value="Himachal Pradesh">Himachal Pradesh</option>
                        <option value="Chhattisgarh">Chhattisgarh</option>
                        <option value="West Bengal">West Bengal</option>
                        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                        <option value="Odisha">Odisha</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Telangana">Telangana</option>
                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                        <option value="Bihar">Bihar</option>
                        <option value="Assam">Assam</option>
                        <option value="Meghalaya">Meghalaya</option>
                        <option value="Manipur">Manipur</option>
                        <option value="Nagaland">Nagaland</option>
                        <option value="Mizoram">Mizoram</option>
                        <option value="Sikkim">Sikkim</option>
                        <option value="Tripura">Tripura</option>
                </select>
            </div>
                <div class="form-group">
                    <label for="placeSelect" id="placeSelectLabel">Select Historical Place:</label>
                    <select id="placeSelect" name="place" required>
                        <option value="">First Select a State</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="visit_date">{{ _('visit_date') }}</label>
                <input type="date" id="visit_date" name="visit_date" required min="{{ today_date }}">
            </div>

            <div class="form-group">
                <label for="visitors">{{ _('num_visitors') }}</label>
                <input type="number" id="visitors" name="visitors" required min="1" max="10">
            </div>

            <div class="form-group">
                <label for="tourType">Select Tour Type:</label>
                <select id="tourType" name="tourType" required onchange="toggleTourPackages()">
                    <option value="">Choose Tour Type</option>
                    <option value="individual">Individual Visit</option>
                    <option value="guided">Hire Tour Guide</option>
                </select>
            </div>

            <div id="tourPackagesSection" style="display: none;">
                <div class="form-group">
                    <label for="tourPackage">Available Tour Packages:</label>
                    <select id="tourPackage" name="tourPackage">
                        <option value="">Select a Package</option>
                    </select>
                </div>
                
                <div id="selectedPackageInfo" class="alert alert-info mt-2" style="display: none;">
                    <h5 class="package-name mb-2"></h5>
                    <p class="package-description mb-2"></p>
                    <div class="package-price"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="name">{{ _('customer_name') }}</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="email">{{ _('email_address') }}</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div class="form-group">
                <label for="citizenship">Citizenship:</label>
                <select id="citizenship" name="citizenship" required onchange="toggleDocumentUpload()">
                    <option value="">Select Citizenship</option>
                    <option value="indian">Indian</option>
                    <option value="foreign">Foreign</option>
                </select>
            </div>

            <div id="indianDocuments" class="form-group" style="display: none;">
                <label for="aadhar">Upload Aadhar Card (PDF):</label>
                <input type="file" id="aadhar" name="aadhar" accept=".pdf" onchange="validateFile(this, 'aadhar')">
                <div id="aadharError" class="error-message"></div>
            </div>

            <div id="foreignDocuments" class="form-group" style="display: none;">
                <label for="passport">Upload Passport (PDF):</label>
                <input type="file" id="passport" name="passport" accept=".pdf" onchange="validateFile(this, 'passport')">
                <div id="passportError" class="error-message"></div>
                <label for="visa">Upload Visa (PDF):</label>
                <input type="file" id="visa" name="visa" accept=".pdf" onchange="validateFile(this, 'visa')">
                <div id="visaError" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="phone">{{ _('phone') }}</label>
                <input type="tel" id="phone" name="phone" required>
            </div>

            <div class="form-group">
                <label for="special_requests">{{ _('special_requests') }}</label>
                <textarea id="special_requests" name="special_requests"></textarea>
            </div>


            <button type="submit" class="submit-btn">{{ _('proceed_to_payment') }}</button>
        </form>
    </div>

    <div class="map-section">
    <div class="map-container">
        <h3 class="map-title">Heritage Map</h3>
            <div id="map" class="map-frame"></div>
        
        <div class="hotel-recommendations" id="hotel-recommendations">
            <h4 class="hotel-section-title">Recommended Hotels Nearby</h4>
            <div class="no-hotels-message">Select a historical place to view nearby hotels</div>
            <div class="hotel-cards"></div>
            </div>
                </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ _('complete_payment') }}</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="paymentForm">
                <div class="form-group">
                    <label for="amount">{{ _('total_amount') }}:</label>
                    <input type="text" id="amount" readonly>
                </div>

                <div class="form-group">
                    <label for="paymentMethod">{{ _('payment_method') }}:</label>
                    <select id="paymentMethod" name="paymentMethod">
                        <option value="credit">{{ _('credit_card') }}</option>
                        <option value="debit">{{ _('debit_card') }}</option>
                        <option value="upi">{{ _('upi') }}</option>
                        <option value="netbanking">{{ _('netbanking') }}</option>
                        <option value="wallet">{{ _('wallet') }}</option>
                    </select>
                </div>

                <div id="cardDetails">
                    <div class="form-group">
                        <label for="cardNumber">{{ _('card_number') }}:</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="form-group">
                        <label for="expiry">{{ _('expiry_date') }}:</label>
                        <input type="text" id="expiry" placeholder="MM/YY">
                    </div>
                    <div class="form-group">
                        <label for="cvv">{{ _('cvv') }}:</label>
                        <input type="text" id="cvv" placeholder="123">
                    </div>
                </div>

                <div id="upiDetails" style="display: none;">
                    <div class="form-group">
                        <label for="upiId">{{ _('upi_id') }}:</label>
                        <input type="text" id="upiId" placeholder="username@upi">
                    </div>
                </div>

                <button type="submit" class="pay-btn">{{ _('pay_now') }}</button>
            </form>
        </div>
    </div>
</div>

<!-- Demo Payment Modal -->
<div class="modal fade" id="demoPaymentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('complete_payment') }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="step1">
                    <h6 class="mb-3">{{ _('select_payment_method') }}</h6>
                    <div class="payment-methods">
                        <button class="payment-method-btn" data-method="card">
                            <i class="fas fa-credit-card"></i> {{ _('credit_debit_card') }}
                        </button>
                        <button class="payment-method-btn" data-method="upi">
                            <i class="fas fa-mobile-alt"></i> {{ _('upi_payment') }}
                        </button>
                        <button class="payment-method-btn" data-method="coins">
                            <i class="fas fa-coins"></i> Itihaas Coins
                        </button>
                    </div>
                </div>

                <!-- Card Payment Form -->
                <div id="cardPaymentForm" style="display: none;">
                    <div class="payment-form">
                        <div class="form-group">
                            <label for="card_number">Card Number</label>
                            <input type="text" class="form-control" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" required>
                        </div>
                        <div class="form-group row">
                            <div class="col-6">
                                <label for="expiry_date">Expiry Date</label>
                                <input type="text" class="form-control" id="expiry_date" name="expiry_date" placeholder="MM/YY" required>
                            </div>
                            <div class="col-6">
                                <label for="card_cvv">CVV</label>
                                <input type="password" class="form-control" id="card_cvv" name="card_cvv" placeholder="123" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="card_name">Name on Card</label>
                            <input type="text" class="form-control" id="card_name" name="card_name" placeholder="John Doe" required>
                        </div>
                        <button type="button" class="btn btn-primary btn-block" onclick="processCardPayment()">Pay ₹<span id="card-payment-amount"></span></button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="showPaymentMethods()">Back</button>
                    </div>
                </div>

                <!-- UPI Payment Form -->
                <div id="upiPaymentForm" style="display: none;">
                    <div class="payment-form">
                        <div class="form-group">
                            <label for="upiId">UPI ID</label>
                            <input type="text" class="form-control" id="upiId" placeholder="username@upi" required>
                        </div>
                        <button type="button" class="btn btn-primary btn-block" onclick="processUPIPayment()">Pay ₹<span id="upi-payment-amount"></span></button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="showPaymentMethods()">Back</button>
                    </div>
                </div>
                
                <div id="processingPayment" style="display: none;">
                    <div class="text-center">
                        <div class="spinner"></div>
                        <h6 class="mt-3">{{ _('processing_payment') }}</h6>
                        <div class="transaction-details mt-3">
                            <p><strong>Amount:</strong> ₹<span id="processing-amount"></span></p>
                            <p><strong>Coins to be used:</strong> <span id="processing-coins"></span></p>
                            <p><strong>Remaining balance:</strong> <span class="remaining-balance">{{ current_user.itihaas_coins.coins if current_user.itihaas_coins else 0 }}</span> coins</p>
                        </div>
                        <p class="text-muted">{{ _('please_wait') }}</p>
                    </div>
                </div>
                
                <div id="paymentSuccess" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-check-circle success-icon"></i>
                        <h6 class="mt-3">{{ _('payment_success') }}</h6>
                        <div class="transaction-summary mt-3">
                            <p><strong>Transaction ID:</strong> <span id="transaction-id"></span></p>
                            <p><strong>Amount Paid:</strong> ₹<span id="amount-paid"></span></p>
                            <p><strong>Reward Earned:</strong> <span id="reward-coins"></span> Itihaas Coins</p>
                            <p><strong>New Balance:</strong> <span id="new-balance"></span> coins</p>
                        </div>
                        <p class="mt-3">{{ _('redirecting') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('visit_date').min = today;

    // Form validation
    document.querySelector('.booking-form').addEventListener('submit', function(e) {
        const visitDate = new Date(document.getElementById('visit_date').value);
        const today = new Date();
        
        if (visitDate < today) {
            e.preventDefault();
            alert('Please select a future date for your visit.');
        }
    });

    // Get package details from session storage
    const selectedPackage = sessionStorage.getItem('selectedPackage');
    const selectedLocation = sessionStorage.getItem('selectedLocation');
    const festivalType = sessionStorage.getItem('festivalType');
    const packagePrice = sessionStorage.getItem('packagePrice');
    
    if (selectedPackage && selectedLocation) {
        // Pre-fill the monument select
        const monumentSelect = document.getElementById('monument');
        const packageOption = new Option(`${selectedPackage} - ${selectedLocation}`, selectedPackage);
        monumentSelect.add(packageOption);
        monumentSelect.value = selectedPackage;
        
        // Update price info
        const priceInfo = document.querySelector('.price-info');
        if (priceInfo && packagePrice) {
            priceInfo.innerHTML = `
                <p>Festival Package: ${festivalType}</p>
                <p>Base price per person: ₹${packagePrice}</p>
                <p>Package includes:</p>
                <ul style="text-align: left; margin: 10px auto; max-width: 300px;">
                    <li>Monument entry tickets</li>
                    <li>Festival special events access</li>
                    <li>Local guide services</li>
                    <li>Traditional welcome kit</li>
                </ul>
                <p><small>Additional charges may apply based on the date selected</small></p>
            `;
        }
        
        // Clear session storage
        sessionStorage.removeItem('selectedPackage');
        sessionStorage.removeItem('selectedLocation');
        sessionStorage.removeItem('festivalType');
        sessionStorage.removeItem('packagePrice');
    }

    const hotelData = {
        "Agra": [
            {
                name: "The Oberoi Amarvilas",
                image: "/static/The Oberoi Amarvilas.jpg",
                rating: 5,  
                price: "₹25,000/night",
                features: ["Taj View", "Spa", "Pool", "5-Star"],
                distance: "600m from Taj Mahal"
            },
            {
                name: "Taj Hotel & Convention Centre",
                image: "/static/Taj Hotel & Convention Centre.avif",
                rating: 4.5,
                price: "₹12,000/night",
                features: ["Rooftop Pool", "Multiple Restaurants", "Spa"],
                distance: "2km from Taj Mahal"
            },
            {
                name: "Crystal Sarovar Premiere",
                image: "/static/Crystal Sarovar Premiere.jpeg",
                rating: 4,
                price: "₹6,000/night",
                features: ["City View", "Restaurant", "Fitness Center"],
                distance: "3km from Taj Mahal"
            }
        ],
        "Delhi": [
            {
                name: "The Imperial",
                image: "/static/The Imperial.jpg",
                rating: 5,
                price: "₹20,000/night",
                features: ["Heritage Property", "Spa", "Fine Dining", "5-Star"],
                distance: "Near Connaught Place"
            },
            {
                name: "The Leela Palace",
                image: "/static/The Leela Palace.jpg",
                rating: 5,
                price: "₹18,000/night",
                features: ["Luxury Spa", "Multiple Restaurants", "Pool"],
                distance: "Diplomatic Enclave"
            },
            {
                name: "Taj Palace",
                image: "/static/Taj Palace.jpg",
                rating: 4.5,
                price: "₹15,000/night",
                features: ["Business Center", "Spa", "Fine Dining"],
                distance: "Diplomatic Area"
            }
        ],
        "Maharashtra": [
            {
                name: "Taj Mahal Palace Mumbai",
                image: "/static/Taj Mahal Palace Mumbai.jpg",
                rating: 5,
                price: "₹30,000/night",
                features: ["Sea View", "Heritage", "Luxury Spa", "5-Star"],
                distance: "Gateway of India"
            },
            {
                name: "The Oberoi Mumbai",
                image: "/static/The Oberoi Mumbai.jpeg",
                rating: 5,
                price: "₹25,000/night",
                features: ["Ocean View", "Fine Dining", "Spa"],
                distance: "Marine Drive"
            }
        ],
        "Rajasthan": [
            {
                name: "Taj Lake Palace Udaipur",
                image: "/static/Taj Lake Palace Udaipur.jpg",
                rating: 5,
                price: "₹35,000/night",
                features: ["Lake View", "Heritage", "Royal Experience"],
                distance: "Lake Pichola"
            },
            {
                name: "Rambagh Palace Jaipur",
                image: "/static/Rambagh Palace Jaipur.jpeg",
                rating: 5,
                price: "₹30,000/night",
                features: ["Royal Palace", "Heritage", "Luxury Spa"],
                distance: "Central Jaipur"
            }
        ],
        "Kerala": [
            {
                name: "Kumarakom Lake Resort",
                image: "/static/Kumarakom Lake Resort.avif",
                rating: 4.5,
                price: "₹20,000/night",
                features: ["Backwater View", "Ayurveda Center", "Pool"],
                distance: "Kumarakom Lake"
            },
            {
                name: "The Leela Kovalam",
                image: "/static/The Leela Kovalam.jpg",
                rating: 5,
                price: "₹18,000/night",
                features: ["Beach Access", "Spa", "Sea View"],
                distance: "Kovalam Beach"
            }
        ],
        "Goa": [
            {
                name: "Taj Fort Aguada Resort & Spa",
                image: "/static/Taj Fort Aguada Resort & Spa.jpg",
                rating: 5,
                price: "₹22,000/night",
                features: ["Beach Access", "Heritage Property", "Spa", "Pool"],
                distance: "500m from Aguada Fort"
            },
            {
                name: "W Goa",
                image: "/static/W Goa.jpeg",
                rating: 5,
                price: "₹25,000/night",
                features: ["Private Beach", "Modern Design", "Spa"],
                distance: "1km from Vagator Beach"
            },
            {
                name: "Grand Hyatt Goa",
                image: "/static/Grand Hyatt Goa.webp",
                rating: 4.5,
                price: "₹18,000/night",
                features: ["River View", "Casino", "Multiple Pools"],
                distance: "2km from Bambolim Beach"
            }
        ],
        "Karnataka": [
            {
                name: "Taj West End Bangalore",
                image: "/static/Taj West End Bangalore.jpeg",
                rating: 5,
                price: "₹20,000/night",
                features: ["Heritage", "Garden View", "Spa"],
                distance: "1km from Bangalore Palace"
            },
            {
                name: "Evolve Back Hampi",
                image: "/static/Evolve Back Hampi.jpeg",
                rating: 4.5,
                price: "₹28,000/night",
                features: ["Heritage Design", "Pool", "Spa"],
                distance: "3km from Hampi Ruins"
            }
        ],
        "Tamil Nadu": [
            {
                name: "ITC Grand Chola Chennai",
                image: "https://www.itchotels.com/content/dam/itchotels/in/umbrella/itc/hotels/itcgrandchola-chennai/images/overview/overview-desktop/exterior-dusk.png",
                rating: 5,
                price: "₹16,000/night",
                features: ["Luxury Spa", "Multiple Restaurants", "Pool"],
                distance: "5km from Marina Beach"
            },
            {
                name: "Taj Coromandel",
                image: "/static/Taj Coromandel.jpeg",
                rating: 4.5,
                price: "₹14,000/night",
                features: ["Business Center", "Spa", "Fine Dining"],
                distance: "2km from Express Avenue Mall"
            }
        ],
        "Gujarat": [
            {
                name: "The Leela Palace Gandhinagar",
                image: "https://www.theleela.com/assets/images/hotels/gandhinagar/homepage/leela-palace-gandhinagar-exterior.jpg",
                rating: 5,
                price: "₹12,000/night",
                features: ["River View", "Spa", "Modern Design"],
                distance: "1km from Akshardham Temple"
            },
            {
                name: "Taj Skyline Ahmedabad",
                image: "https://www.tajhotels.com/content/dam/luxury/hotels/taj-skyline-ahmedabad/images/4x3/Facade_4x3.jpg",
                rating: 4.5,
                price: "₹10,000/night",
                features: ["City View", "Rooftop Restaurant", "Spa"],
                distance: "3km from Sabarmati Riverfront"
            }
        ],
        "West Bengal": [
            {
                name: "The Oberoi Grand Kolkata",
                image: "https://www.oberoihotels.com/-/media/oberoi-hotels/website-images/the-oberoi-grand-kolkata/gallery/detail/overview-1.jpg",
                rating: 5,
                price: "₹15,000/night",
                features: ["Heritage Property", "Pool", "Spa"],
                distance: "1km from Park Street"
            },
            {
                name: "ITC Royal Bengal",
                image: "https://www.itchotels.com/content/dam/itchotels/in/umbrella/itc/hotels/itcroyalbengal-kolkata/images/overview/overview-desktop/exterior-dusk.png",
                rating: 5,
                price: "₹13,000/night",
                features: ["Modern Luxury", "Multiple Restaurants", "Spa"],
                distance: "4km from Science City"
            }
        ],
        "Madhya Pradesh": [
            {
                name: "Taj Usha Kiran Palace Gwalior",
                image: "/static/Taj Usha Kiran Palace Gwalior.jpeg",
                rating: 5,
                price: "₹12,000/night",
                features: ["Heritage Palace", "Garden", "Spa"],
                distance: "2km from Gwalior Fort"
            },
            {
                name: "Radisson Bhopal",
                image: "/static/Radisson Bhopal.jpeg",
                rating: 4,
                price: "₹8,000/night",
                features: ["City View", "Modern Amenities", "Restaurant"],
                distance: "3km from Van Vihar National Park"
            }
        ],
        "Uttarakhand": [
            {
                name: "The Taj Rishikesh",
                image: "/static/The Taj Rishikesh.jpeg",
                rating: 5,
                price: "₹25,000/night",
                features: ["River View", "Yoga Center", "Spa"],
                distance: "1km from Triveni Ghat"
            },
            {
                name: "Ananda in the Himalayas",
                image: "/static/Ananda in the Himalayas.jpeg",
                rating: 5,
                price: "₹35,000/night",
                features: ["Mountain View", "Wellness Resort", "Ayurveda"],
                distance: "5km from Rishikesh"
            }
        ],
        "Himachal Pradesh": [
            {
                name: "Wildflower Hall Shimla",
                image: "/static/Wildflower Hall Shimla.jpeg",
                rating: 5,
                price: "₹30,000/night",
                features: ["Mountain View", "Luxury Spa", "Heritage"],
                distance: "3km from The Mall Road"
            },
            {
                name: "The Himalayan",
                image: "/static/The Himalayan.jpeg",
                rating: 4.5,
                price: "₹15,000/night",
                features: ["Castle Hotel", "Valley View", "Restaurant"],
                distance: "2km from Christ Church"
            }
        ]
    };

    // Add a function to handle image loading errors
    function handleImageError(img) {
        img.onerror = null; // Prevent infinite loop
        img.src = 'https://dynamic-media-cdn.tripadvisor.com/media/photo-o/0f/5e/3e/41/default-hotel-photo.jpg';
    }

    // Update hotel display when state is selected
    document.getElementById('stateSelect').addEventListener('change', function() {
        const selectedState = this.value;
        const hotelRecommendations = document.getElementById('hotel-recommendations');
        const hotelCardsContainer = hotelRecommendations.querySelector('.hotel-cards');
        const noHotelsMessage = hotelRecommendations.querySelector('.no-hotels-message');
        
        // Clear existing hotel cards
        hotelCardsContainer.innerHTML = '';
        
        if (selectedState && hotelData[selectedState]) {
            // Hide the no hotels message
            noHotelsMessage.style.display = 'none';
            // Show the cards container
            hotelCardsContainer.style.display = 'grid';
            
            // Update section title
            document.querySelector('.hotel-section-title').textContent = `Top Hotels in ${selectedState}`;
            
            // Add hotel cards
            hotelData[selectedState].forEach(hotel => {
                const hotelCard = document.createElement('div');
                hotelCard.className = 'hotel-card';
                
                const stars = '⭐'.repeat(Math.floor(hotel.rating));
                
                hotelCard.innerHTML = `
                    <img src="${hotel.image}" 
                         alt="${hotel.name}" 
                         class="hotel-image" 
                         onerror="handleImageError(this)"
                         loading="lazy">
                    <div class="hotel-info">
                        <div class="hotel-name">${hotel.name}</div>
                        <div class="hotel-rating">${stars} ${hotel.rating}</div>
                        <div class="hotel-price">${hotel.price}</div>
                        <div class="hotel-distance">
                            <i class="fas fa-map-marker-alt"></i>
                            ${hotel.distance}
                        </div>
                        <div class="hotel-features">
                            ${hotel.features.map(feature => `<span class="hotel-feature">${feature}</span>`).join('')}
                        </div>
                    </div>
                `;
                
                hotelCardsContainer.appendChild(hotelCard);
            });
        } else {
            // Show the no hotels message
            noHotelsMessage.style.display = 'block';
            noHotelsMessage.textContent = selectedState ? 
                `No hotels available in ${selectedState} at the moment` : 
                'Select a state to view available hotels';
            // Hide the cards container
            hotelCardsContainer.style.display = 'none';
            // Reset section title
            document.querySelector('.hotel-section-title').textContent = 'Recommended Hotels Nearby';
        }
    });

    function toggleDocumentUpload() {
        const citizenship = document.getElementById('citizenship').value;
        const indianDocuments = document.getElementById('indianDocuments');
        const foreignDocuments = document.getElementById('foreignDocuments');
        
        // Hide both document sections first
        indianDocuments.style.display = 'none';
        foreignDocuments.style.display = 'none';
        
        // Show the appropriate section based on selection
        if (citizenship === 'indian') {
            indianDocuments.style.display = 'block';
        } else if (citizenship === 'foreign') {
            foreignDocuments.style.display = 'block';
        }
    }

    function validateFile(input, type) {
        const file = input.files[0];
        const errorDiv = document.getElementById(`${type}Error`);
        
        // Reset error message
        errorDiv.textContent = '';
        
        // Check if file is selected
        if (!file) {
            errorDiv.textContent = 'Please select a file';
            return false;
        }
        
        // Check file type
        if (file.type !== 'application/pdf') {
            errorDiv.textContent = 'Please upload a PDF file';
            input.value = ''; // Clear the input
            return false;
        }
        
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            errorDiv.textContent = 'File size should be less than 5MB';
            input.value = ''; // Clear the input
            return false;
        }
        
        return true;
    }

    function handleBookingSubmit(e) {
        e.preventDefault();
        
        // Validate form
        const form = document.getElementById('bookingForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return false;
        }
        
        // Validate documents based on citizenship
        const citizenship = document.getElementById('citizenship').value;
        let isValid = true;
        
        if (citizenship === 'indian') {
            const aadharInput = document.getElementById('aadhar');
            if (!validateFile(aadharInput, 'aadhar')) {
                isValid = false;
            }
        } else if (citizenship === 'foreign') {
            const passportInput = document.getElementById('passport');
            const visaInput = document.getElementById('visa');
            if (!validateFile(passportInput, 'passport') || !validateFile(visaInput, 'visa')) {
                isValid = false;
            }
        }
        
        if (!isValid) {
            return false;
        }
        
        // Get package information
        const packageSelect = document.getElementById('tourPackage');
        const selectedPackage = packageSelect.value ? {
            id: packageSelect.value,
            name: packageSelect.options[packageSelect.selectedIndex].text
        } : null;

        // Collect booking data
        const bookingData = {
            state: document.getElementById('stateSelect').value,
            place: document.getElementById('placeSelect').value,
            visit_date: document.getElementById('visit_date').value,
            visitors: document.getElementById('visitors').value,
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            special_requests: document.getElementById('special_requests').value,
            amount: parseFloat(document.getElementById('total_amount').value),
            booking_type: selectedPackage ? 'package' : 'individual',
            package_info: selectedPackage,
            monument_name: selectedPackage ? selectedPackage.name : `${document.getElementById('stateSelect').value} - ${document.getElementById('placeSelect').value}`
        };

        // Store booking data for later use
        window.currentBookingData = bookingData;

        // Update payment amount display
        document.querySelectorAll('.payment-amount').forEach(el => {
            el.textContent = bookingData.amount;
        });

        // Show payment modal using Bootstrap
        $('#demoPaymentModal').modal('show');

        // Handle payment method selection
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.onclick = function() {
                const paymentMethod = this.getAttribute('data-method');
                handlePaymentMethodSelection(paymentMethod, bookingData);
            };
        });

        return false;
    }

    function handlePaymentMethodSelection(method, bookingData) {
        // Hide all payment forms first
        document.getElementById('step1').style.display = 'none';
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';

        switch(method) {
            case 'card':
                document.getElementById('cardPaymentForm').style.display = 'block';
                break;
            case 'upi':
                document.getElementById('upiPaymentForm').style.display = 'block';
                break;
            case 'coins':
                processCoinsPayment(bookingData);
                break;
        }
    }

    function showPaymentMethods() {
        // Reset the step1 content to original payment methods
        document.getElementById('step1').innerHTML = `
            <h6 class="mb-3">{{ _('select_payment_method') }}</h6>
            <div class="payment-methods">
                <button class="payment-method-btn" data-method="card">
                    <i class="fas fa-credit-card"></i> {{ _('credit_debit_card') }}
                </button>
                <button class="payment-method-btn" data-method="upi">
                    <i class="fas fa-mobile-alt"></i> {{ _('upi_payment') }}
                </button>
                <button class="payment-method-btn" data-method="coins">
                    <i class="fas fa-coins"></i> Itihaas Coins
                </button>
            </div>
        `;

        // Reattach event listeners
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.onclick = function() {
                const paymentMethod = this.getAttribute('data-method');
                handlePaymentMethodSelection(paymentMethod, window.currentBookingData);
            }
        });

        // Show the payment methods
        document.getElementById('step1').style.display = 'block';
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';
    }

    function processCardPayment() {
        const cardNumber = document.getElementById('card_number').value.trim();
        const expiryDate = document.getElementById('expiry_date').value.trim();
        const cvv = document.getElementById('card_cvv').value.trim();
        const cardName = document.getElementById('card_name').value.trim();

        // Debug information
        console.log('Card Number:', cardNumber);
        console.log('Expiry Date:', expiryDate);
        console.log('CVV:', cvv);
        console.log('Card Name:', cardName);

        // Validate each field individually
        if (!cardNumber) {
            alert('Please enter card number');
            return;
        }
        if (!expiryDate) {
            alert('Please enter expiry date');
            return;
        }
        if (!cvv) {
            alert('Please enter CVV');
            return;
        }
        if (!cardName) {
            alert('Please enter name on card');
            return;
        }

        // Additional validation for card number format (16 digits)
        const cardNumberClean = cardNumber.replace(/\s/g, '');
        if (!/^\d{16}$/.test(cardNumberClean)) {
            alert('Please enter a valid 16-digit card number');
            return;
        }

        // Validate expiry date format (MM/YY)
        if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
            alert('Please enter expiry date in MM/YY format');
            return;
        }

        // Validate CVV (3 digits)
        if (!/^\d{3}$/.test(cvv)) {
            alert('Please enter a valid 3-digit CVV');
            return;
        }

        // If all validations pass, process the booking
        processBooking(window.currentBookingData, 'card');
    }

    function processUPIPayment() {
        const upiId = document.getElementById('upiId').value;

        if (!upiId) {
            alert('Please enter UPI ID');
            return;
        }

        processBooking(window.currentBookingData, 'upi');
    }

    function processCoinsPayment(bookingData) {
        const currentCoins = parseInt(document.querySelector('.coins-balance').textContent.match(/\d+/)[0]) || 0;
        const totalAmount = bookingData.amount;

        // Show processing state
        document.getElementById('step1').style.display = 'none';
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';
        document.getElementById('processingPayment').style.display = 'block';
        document.getElementById('processing-amount').textContent = totalAmount;
        document.getElementById('processing-coins').textContent = currentCoins;

        // Calculate how much can be paid with coins
        const coinsToUse = Math.min(currentCoins, totalAmount);
        const remainingAmount = totalAmount - coinsToUse;

        // Simulate API call (replace with actual API endpoint)
        setTimeout(() => {
            // Simulate successful booking
            const transactionId = 'TXN' + Math.floor(Math.random() * 1000000);
            
            // Update transaction details
            document.getElementById('transaction-id').textContent = transactionId;
            document.getElementById('amount-paid').textContent = totalAmount;
            
            // Calculate and display reward coins (10% of booking amount)
            const rewardCoins = Math.floor(totalAmount * 0.1);
            document.getElementById('reward-coins').textContent = rewardCoins;
            
            // Update new balance (subtract used coins and add reward coins)
            const newBalance = currentCoins - coinsToUse + rewardCoins;
            document.getElementById('new-balance').textContent = newBalance;

            // Send reward coins to backend
            fetch('/update-coins', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    reward_coins: rewardCoins,
                    transaction_id: transactionId,
                    used_coins: coinsToUse
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update navbar coins balance
                    document.querySelector('.coins-balance').textContent = data.new_balance;
                }
            })
            .catch(error => console.error('Error updating coins:', error));

            // Show appropriate message based on remaining amount
            if (remainingAmount > 0) {
                // Show remaining amount to be paid
                document.getElementById('paymentSuccess').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle success-icon"></i>
                        <h6 class="mt-3">Partial Payment Successful</h6>
                        <div class="transaction-summary mt-3">
                            <p><strong>Transaction ID:</strong> <span id="transaction-id">${transactionId}</span></p>
                            <p><strong>Amount Paid with Coins:</strong> ₹${coinsToUse}</p>
                            <p><strong>Remaining Amount:</strong> ₹${remainingAmount}</p>
                            <p><strong>Reward Earned:</strong> <span id="reward-coins">${rewardCoins}</span> Itihaas Coins</p>
                            <p><strong>New Balance:</strong> <span id="new-balance">${newBalance}</span> coins</p>
                        </div>
                        <p class="mt-3">Please complete the remaining payment of ₹${remainingAmount}</p>
                        <div class="payment-methods mt-3">
                            <button class="payment-method-btn" onclick="handlePaymentMethodSelection('card', window.currentBookingData)">
                                <i class="fas fa-credit-card"></i> Pay with Card
                            </button>
                            <button class="payment-method-btn" onclick="handlePaymentMethodSelection('upi', window.currentBookingData)">
                                <i class="fas fa-mobile-alt"></i> Pay with UPI
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Show full payment success
                document.getElementById('paymentSuccess').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle success-icon"></i>
                        <h6 class="mt-3">{{ _('payment_success') }}</h6>
                        <div class="transaction-summary mt-3">
                            <p><strong>Transaction ID:</strong> <span id="transaction-id">${transactionId}</span></p>
                            <p><strong>Amount Paid:</strong> ₹${totalAmount}</p>
                            <p><strong>Reward Earned:</strong> <span id="reward-coins">${rewardCoins}</span> Itihaas Coins</p>
                            <p><strong>New Balance:</strong> <span id="new-balance">${newBalance}</span> coins</p>
                        </div>
                        <p class="mt-3">{{ _('redirecting') }}</p>
                    </div>
                `;
            }
                
            // Show success message
            document.getElementById('processingPayment').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';

            // Only redirect if payment is complete
            if (remainingAmount === 0) {
                setTimeout(() => {
                    window.location.href = '/booking-history';
                }, 3000);
            }
        }, 2000);
    }

    function processBooking(bookingData, paymentMethod) {
        // Show processing state
        document.getElementById('step1').style.display = 'none';
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';
        document.getElementById('processingPayment').style.display = 'block';
        document.getElementById('processing-amount').textContent = bookingData.amount;

        // Simulate API call (replace with actual API endpoint)
        setTimeout(() => {
            // Simulate successful booking
            const transactionId = 'TXN' + Math.floor(Math.random() * 1000000);
            
            // Update transaction details
            document.getElementById('transaction-id').textContent = transactionId;
            document.getElementById('amount-paid').textContent = bookingData.amount;
            
            // Calculate and display reward coins (10% of booking amount)
            const rewardCoins = Math.floor(bookingData.amount * 0.1);
            document.getElementById('reward-coins').textContent = rewardCoins;
            
            // Update new balance
            const currentBalance = parseInt(document.querySelector('.coins-balance').textContent.match(/\d+/)[0]) || 0;
            const newBalance = currentBalance + rewardCoins;
            document.getElementById('new-balance').textContent = newBalance;

            // Send booking data to backend
            fetch('/api/process-booking-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bookingData: {
                        monument: bookingData.place,  // Changed from place to monument
                        visit_date: bookingData.visit_date,
                        visitors: bookingData.visitors,
                        amount: bookingData.amount,
                        special_requests: bookingData.special_requests,
                        name: bookingData.name,
                        email: bookingData.email,
                        phone: bookingData.phone
                    },
                    paymentMethod: paymentMethod
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Send reward coins to backend
                    return fetch('/update-coins', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            reward_coins: rewardCoins,
                            transaction_id: transactionId
                        })
                    });
                } else {
                    throw new Error(data.error || 'Failed to process booking');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update navbar coins balance
                    document.querySelector('.coins-balance').textContent = data.new_balance;
                }
            })
            .catch(error => console.error('Error:', error));
                
            // Show success message
            document.getElementById('processingPayment').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';

            // Redirect to booking history page after 3 seconds
            setTimeout(() => {
                window.location.href = '/booking-history';
            }, 3000);
        }, 2000);
    }

    function toggleSound() {
        const video = document.getElementById('bgVideo');
        const icon = document.getElementById('soundIcon');
        
        if (video.muted) {
            video.muted = false;
            icon.className = 'fas fa-volume-up';
        } else {
            video.muted = true;
            icon.className = 'fas fa-volume-mute';
        }
    }

    // Start with muted video
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('bgVideo');
        video.muted = true;
    });

    const historicalPlaces = {
        "Agra": ["Taj Mahal", "Agra Fort", "Fatehpur Sikri", "Itimad-ud-Daulah's Tomb (Baby Taj)", "Akbar's Tomb (Sikandra)"],
        "Maharashtra": ["Chhatrapati Shivaji Terminus", "The Gateway of India, Mumbai", "Ajanta and Ellora Caves, Aurangabad", "Bibi-ka-Maqbara, Aurangabad", "Sindhudurg Fort, Sindhudurg", "Shaniwar Wada, Pune", "Chand Minar, Daulatabad", "Pratapgad Fort, Satara", "Elephanta Caves", "Aga Khan Palace"],
        "Delhi": ["Lotus Temple", "Humayun's Tomb", "Red Fort (Lal Qila)", "India Gate", "Jama Masjid", "Qutub Minar"],
        "Goa": ["Basilica of Bom Jesus", "Chapora Fort", "Aguada Fort", "Se Cathedral", "Safa Masjid", "St. Cajetan Church"],
        "Kerala": ["Krishnapuram Palace", "Bekal Fort", "Jewish Synagogue", "Fort Kochi", "Dutch Palace", "Edakkal Caves"],
        "Rajasthan": ["Hawa Mahal", "Jaisalmer Fort", "City Palace of Jaipur", "Jantar Mantar", "Chittorgarh Fort"],
        "Punjab": ["Golden Temple", "Jallianwala Bagh", "Wagah Border", "Lodhi Fort", "Phillaur Fort"],
        "Karnataka": ["Hampi", "Madhukeshwara Temple", "Mysore Palace", "Bidar Fort", "Badami Caves"],
        "Tamil Nadu": ["Brihadishvara Temple", "Mahabalipuram", "Meenakshi Temple", "Thiruvalluvar Statue"],
        "Jharkhand": ["Pahari Mandir (Ranchi)", "Jagannath Temple (Ranchi)"],
        "Arunachal Pradesh": ["Ita Fort", "Tawang Monastery", "Bomdila Monastery", "Gorsam Chorten", "Golden Pagoda"],
        "Madhya Pradesh": ["Khajuraho", "Gwalior Fort", "Orchha Fort", "Jama Masjid"],
        "Uttarakhand": ["Badrinath", "Jageshwar", "Bageshwar", "Katarmal Sun Temple"],
        "Uttar Pradesh": ["Jhansi Fort", "Chunar Fort", "Sarnath Stupa"],
        "Himachal Pradesh": ["Baijnath Temple", "Kangra Fort", "Champavati Temple", "Tabo Monastery"],
        "Chhattisgarh": ["Ancient Sculpture in Danteswari Temple", "Chandraditya Temple", "Ganesh Statue", "Mama Bhanja Temple"],
        "West Bengal": ["Cooch Behar Palace", "Bishnupur Terracotta Temples", "Hazarduari Palace", "Victoria Memorial"],
        "Jammu and Kashmir": ["Hari Parbat Fort", "Pari Mahal"],
        "Odisha": ["Konark Sun Temple", "Lingaraja Temple", "Jagannath Temple, Puri", "Udayagiri and Khandagiri Caves", "Mukteshwar Temple"],
        "Gujarat": ["Rani ki Vav (Queen's Stepwell)", "Sun Temple, Modhera", "Dwarkadhish Temple", "Laxmi Vilas Palace", "Adalaj Stepwell"],
        "Telangana": ["Charminar", "Golconda Fort", "Warangal Fort", "Thousand Pillar Temple", "Ramappa Temple"],
        "Andhra Pradesh": ["Amaravati Stupa", "Lepakshi Temple", "Veerabhadra Temple", "Undavalli Caves", "Simhachalam Temple"],
        "Bihar": ["Mahabodhi Temple", "Nalanda University Ruins", "Golghar", "Vikramshila Ruins", "Rohtasgarh Fort"],
        "Assam": ["Kamakhya Temple", "Rang Ghar", "Talatal Ghar", "Umananda Temple", "Ahom Monuments of Sivasagar"],
        "Meghalaya": ["Nartiang Monoliths", "Mawlynnong Living Root Bridge", "Shillong Peak Sacred Grove", "Umiam Lake", "Mawsmai Cave"],
        "Manipur": ["Kangla Fort", "Shaheed Minar", "Ima Keithel", "Sri Govindajee Temple", "War Cemetery"],
        "Nagaland": ["Kohima War Cemetery", "Kachari Ruins", "Naga Heritage Village", "Doyang Memorial", "Intangki National Park Stone Monoliths"],
        "Mizoram": ["Solomon's Temple", "Durtlang Hills", "Lamsial Puk Cave", "Vantawng Falls Monument", "Sibuta Lung (Sibuta's Memorial Stone)"],
        "Sikkim": ["Rumtek Monastery", "Pemayangtse Monastery", "Enchey Monastery", "Tashiding Monastery", "Dubdi Monastery"],
        "Tripura": ["Ujjayanta Palace", "Neermahal Water Palace", "Unakoti Rock Carvings", "Tripura Sundari Temple", "Bhuvaneswari Temple"]
    };

    document.getElementById('stateSelect').addEventListener('change', function() {
        const stateSelect = document.getElementById('stateSelect');
        const placeSelect = document.getElementById('placeSelect');
        const selectedState = stateSelect.value;
        
        // Clear existing options
        placeSelect.innerHTML = '';
        
        if (selectedState === '') {
            placeSelect.innerHTML = '<option value="">First Select a State</option>';
            return;
        }
        
        // Add places for selected state
        const places = historicalPlaces[selectedState] || [];
        places.forEach(place => {
            const option = document.createElement('option');
            option.value = place;
            option.textContent = place;
            placeSelect.appendChild(option);
        });
        
        if (places.length === 0) {
            placeSelect.innerHTML = '<option value="">No places available</option>';
        }
    });

    // Remove the hardcoded tourPackages object and replace with API call
    let tourPackages = {};

    // Function to fetch tour packages from the API
    async function fetchTourPackages() {
        try {
            console.log('Fetching tour packages...'); // Debug log
            const response = await fetch('/api/get-tour-packages');
            console.log('Response status:', response.status); // Debug log
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Fetched tour packages:', data); // Debug log
            
            if (data.status === 'success') {
                tourPackages = data.packages;
                console.log('Stored tour packages:', tourPackages); // Debug log
                
                // Log available states
                const states = Object.keys(tourPackages);
                console.log('Available states:', states); // Debug log
            } else {
                console.error('Failed to fetch tour packages:', data.error);
            }
        } catch (error) {
            console.error('Error fetching tour packages:', error);
            // Show error message to user
            const packageSelect = document.getElementById('tourPackage');
            packageSelect.innerHTML = '<option value="" disabled>Error loading packages. Please try again later.</option>';
        }
    }

    // Call fetchTourPackages when the page loads
    document.addEventListener('DOMContentLoaded', fetchTourPackages);

    function toggleTourPackages() {
        const tourType = document.getElementById('tourType').value;
        const placeSelect = document.getElementById('placeSelect');
        const placeSelectLabel = document.getElementById('placeSelectLabel');
        const tourPackagesSection = document.getElementById('tourPackagesSection');
        const stateSelect = document.getElementById('stateSelect');
        
        if (tourType === 'guided') {
            // Change label and options for guided tours
            placeSelectLabel.textContent = 'Select Package:';
            placeSelect.innerHTML = '<option value="">Select a Package</option>';
            
            // Get packages for the selected state
            const selectedState = stateSelect.value;
            if (tourPackages[selectedState] && tourPackages[selectedState].length > 0) {
                tourPackages[selectedState].forEach(package => {
                    const option = document.createElement('option');
                    option.value = package.name;  // Changed to only use package name
                    option.textContent = package.name;  // Show only package name
                    placeSelect.appendChild(option);
                });
            } else {
                placeSelect.innerHTML += '<option value="" disabled>No packages available for this state</option>';
            }
            
            tourPackagesSection.style.display = 'block';
        } else {
            // Reset to historical places for individual visits
            placeSelectLabel.textContent = 'Select Historical Place:';
            placeSelect.disabled = false;
            placeSelect.innerHTML = '<option value="">First Select a State</option>';
            if (stateSelect.value) {
                updateHistoricalPlaces(stateSelect.value);
            }
            tourPackagesSection.style.display = 'none';
        }
    }

    // Add state change handler
    document.getElementById('stateSelect').addEventListener('change', function() {
        const tourType = document.getElementById('tourType').value;
        if (tourType === 'guided') {
            toggleTourPackages();
        } else {
            updateHistoricalPlaces(this.value);
        }
    });

    function updateHistoricalPlaces(state) {
        const placeSelect = document.getElementById('placeSelect');
        placeSelect.innerHTML = '<option value="">Select a Place</option>';
        
        if (historicalPlaces[state]) {
            historicalPlaces[state].forEach(place => {
                const option = document.createElement('option');
                option.value = place;
                option.textContent = place;
                placeSelect.appendChild(option);
            });
        }
    }

    function updateTourPackages(state) {
        const packageSelect = document.getElementById('tourPackage');
        packageSelect.innerHTML = '<option value="">Select a Package</option>';
        
        console.log('Updating packages for state:', state); // Debug log
        console.log('Available packages:', tourPackages); // Debug log
        
        if (tourPackages[state] && tourPackages[state].length > 0) {
            console.log('Found packages for state:', tourPackages[state]); // Debug log
            tourPackages[state].forEach(package => {
                const option = document.createElement('option');
                try {
                    option.value = JSON.stringify(package);
                    option.textContent = `${package.name} - ₹${package.price}`;
                    packageSelect.appendChild(option);
                } catch (error) {
                    console.error('Error creating package option:', error);
                }
            });
        } else {
            console.log('No packages found for state:', state); // Debug log
            packageSelect.innerHTML += '<option value="" disabled>No packages available for this state</option>';
        }
    }

    // Update the package selection event listener
    document.getElementById('tourPackage').addEventListener('change', function() {
        const selectedPackageInfo = document.getElementById('selectedPackageInfo');
        const selectedOption = this.options[this.selectedIndex];
        const packageValue = this.value;
        
        if (packageValue) {
            try {
                const packageData = JSON.parse(packageValue);
                selectedPackageInfo.querySelector('.package-name').textContent = packageData.name;
                selectedPackageInfo.querySelector('.package-description').textContent = packageData.description;
                selectedPackageInfo.querySelector('.package-price').textContent = `Price: ₹${packageData.price}`;
                selectedPackageInfo.style.display = 'block';
                
                // Update payment amounts
                updatePaymentAmounts(packageData.price);
            } catch (error) {
                console.error('Error parsing package data:', error);
                selectedPackageInfo.style.display = 'none';
            }
        } else {
            selectedPackageInfo.style.display = 'none';
            const randomAmount = generateRandomAmount();
            updatePaymentAmounts(randomAmount);
        }
    });

    // Add event listener for state selection to update tour packages
    document.getElementById('stateSelect').addEventListener('change', function() {
        const tourType = document.getElementById('tourType').value;
        if (tourType === 'guided') {
            updateTourPackages(this.value);
        }
    });

    function selectPackage() {
            const packageSelect = document.getElementById('tourPackage');
        const selectedPackageValue = packageSelect.value;
        
        if (!selectedPackageValue) {
            return;
        }
        
        try {
            const selectedPackage = JSON.parse(selectedPackageValue);
            
            if (selectedPackage) {
                // Update booking amount based on package price
                const visitors = document.getElementById('visitors').value;
                const amount = selectedPackage.price * visitors;
                
                // Store package details for payment
                window.currentBookingData = {
                    ...window.currentBookingData,
                    package_details: selectedPackage,
                    amount: amount
                };

        // Update payment amount display
        document.querySelectorAll('.payment-amount').forEach(el => {
                    el.textContent = amount;
                });
                
                // Close the package dropdown
                packageSelect.blur();
                
                // Scroll to booking form
                document.querySelector('.booking-form').scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) {
            console.error('Error selecting package:', error);
        }
    }

    function viewGuideProfile() {
        const packageSelect = document.getElementById('tourPackage');
        const selectedPackageValue = packageSelect.value;
        
        if (!selectedPackageValue) {
            alert('Please select a package first');
            return;
        }
        
        try {
            const selectedPackage = JSON.parse(selectedPackageValue);
            console.log('Selected package data:', selectedPackage); // Debug log
            
            if (selectedPackage && selectedPackage.guide) {
                // Use the guide data directly from the package
                const guide = selectedPackage.guide;
                
                // Create and show guide details modal
                const modalHtml = `
                    <div class="modal fade" id="guideDetailsModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Guide Profile</h5>
                                    <button type="button" class="close" data-dismiss="modal">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="guide-profile">
                                        <div class="guide-header">
                                            <img src="${guide.profile_picture || '/static/images/default-avatar.png'}" 
                                                 alt="${guide.name}" 
                                                 class="guide-avatar">
                                            <h4>${guide.name}</h4>
                                        </div>
                                        <div class="guide-info">
                                            <p><strong>Experience:</strong> ${guide.experience || 'Not specified'} years</p>
                                            <p><strong>Languages:</strong> ${(guide.languages || []).join(', ') || 'Not specified'}</p>
                                            <p><strong>Rating:</strong> ${guide.rating || 'Not rated'} ⭐</p>
                                            <p><strong>Total Tours:</strong> ${guide.total_tours || 'Not specified'}</p>
                                            <p><strong>Specialization:</strong> ${guide.specialization || 'Not specified'}</p>
                                        </div>
                                        <div class="guide-description">
                                            <h5>About</h5>
                                            <p>${guide.description || 'No description available'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('guideDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add new modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show the modal
                $('#guideDetailsModal').modal('show');
            } else {
                console.error('Guide data not found in package:', selectedPackage); // Debug log
                alert('Guide information is not available for this package. Please try another package or contact support.');
            }
        } catch (error) {
            console.error('Error displaying guide profile:', error);
            alert('Unable to display guide profile. Please try again later.');
        }
    }

    // Add styles for guide profile modal
    const style = document.createElement('style');
    style.textContent = `
        .guide-profile {
            padding: 20px;
        }
        .guide-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .guide-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid #f1683a;
        }
        .guide-header h4 {
            color: #f1683a;
            margin: 0;
        }
        .guide-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .guide-info p {
            margin: 8px 0;
            color: #444;
        }
        .guide-description {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .guide-description h5 {
            color: #333;
            margin-bottom: 10px;
        }
        .guide-description p {
            color: #666;
            line-height: 1.6;
        }
    `;
    document.head.appendChild(style);
</script>

<!-- Add Leaflet CSS and JS in the head section -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Add state coordinates data and map initialization script -->
<script>
    // State coordinates data
    const stateCoordinates = {
        "Agra": { lat: 27.1767, lng: 78.0081, zoom: 12 },
        "Maharashtra": { lat: 19.7515, lng: 75.7139, zoom: 7 },
        "Delhi": { lat: 28.6139, lng: 77.2090, zoom: 11 },
        "Goa": { lat: 15.4989, lng: 73.8278, zoom: 10 },
        "Kerala": { lat: 10.8505, lng: 76.2711, zoom: 8 },
        "Rajasthan": { lat: 27.0238, lng: 74.2179, zoom: 7 },
        "Punjab": { lat: 31.1471, lng: 75.3412, zoom: 8 },
        "Karnataka": { lat: 15.3173, lng: 75.7139, zoom: 7 },
        "Tamil Nadu": { lat: 11.1271, lng: 78.6569, zoom: 7 },
        "Jharkhand": { lat: 23.6102, lng: 85.2799, zoom: 8 },
        "Arunachal Pradesh": { lat: 28.2180, lng: 94.7278, zoom: 8 },
        "Madhya Pradesh": { lat: 23.2599, lng: 77.4126, zoom: 7 },
        "Uttarakhand": { lat: 30.0668, lng: 79.0193, zoom: 8 },
        "Uttar Pradesh": { lat: 26.8467, lng: 80.9462, zoom: 7 },
        "Himachal Pradesh": { lat: 31.1048, lng: 77.1734, zoom: 8 },
        "Chhattisgarh": { lat: 21.2787, lng: 81.8661, zoom: 7 },
        "West Bengal": { lat: 22.5726, lng: 88.3639, zoom: 8 },
        "Jammu and Kashmir": { lat: 32.7266, lng: 74.8570, zoom: 8 },
        "Odisha": { lat: 20.9517, lng: 85.0985, zoom: 8 },
        "Gujarat": { lat: 22.2587, lng: 71.1924, zoom: 7 },
        "Telangana": { lat: 17.3850, lng: 78.4867, zoom: 8 },
        "Andhra Pradesh": { lat: 15.9129, lng: 79.7400, zoom: 7 },
        "Bihar": { lat: 25.0961, lng: 85.3131, zoom: 8 },
        "Assam": { lat: 26.2006, lng: 92.9376, zoom: 8 },
        "Meghalaya": { lat: 25.4670, lng: 91.3662, zoom: 9 },
        "Manipur": { lat: 24.6637, lng: 93.9063, zoom: 9 },
        "Nagaland": { lat: 26.1584, lng: 94.5624, zoom: 9 },
        "Mizoram": { lat: 23.1645, lng: 92.9376, zoom: 9 },
        "Sikkim": { lat: 27.5330, lng: 88.5122, zoom: 9 },
        "Tripura": { lat: 23.9408, lng: 91.9882, zoom: 9 }
    };

    // Monument coordinates data
    const monumentCoordinates = {
        "Uttar Pradesh": [
    { name: "Taj Mahal", lat: 27.173891, lng: 78.042068 }, // :contentReference[oaicite:3]{index=3}
    { name: "Agra Fort", lat: 27.1795, lng: 78.0211 },
    { name: "Fatehpur Sikri", lat: 27.0937, lng: 77.6614 },
    { name: "Itimad-ud-Daulah's Tomb", lat: 27.1924, lng: 78.0373 },
    { name: "Akbar's Tomb", lat: 27.2156, lng: 77.9487 },
    { name: "Jhansi Fort", lat: 25.4588, lng: 78.5746 },
    { name: "Chunar Fort", lat: 25.1276, lng: 82.8830 },
    { name: "Sarnath Stupa", lat: 25.3763, lng: 83.0220 }
  ],
  "Maharashtra": [
    { name: "Chhatrapati Shivaji Terminus", lat: 18.9402, lng: 72.8356 },
    { name: "Gateway of India", lat: 18.9220, lng: 72.8347 },
    { name: "Ajanta Caves", lat: 20.5519, lng: 75.7033 },
    { name: "Ellora Caves", lat: 20.0268, lng: 75.1790 },
    { name: "Bibi-ka-Maqbara", lat: 19.8773, lng: 75.3209 },
    { name: "Sindhudurg Fort", lat: 16.0479, lng: 73.4745 },
    { name: "Shaniwar Wada", lat: 18.5196, lng: 73.8553 },
    { name: "Chand Minar", lat: 20.0263, lng: 75.2336 },
    { name: "Pratapgad Fort", lat: 17.9305, lng: 73.5962 },
    { name: "Elephanta Caves", lat: 18.9633, lng: 72.9310 },
    { name: "Aga Khan Palace", lat: 18.5523, lng: 73.9012 }
  ],
  "Delhi": [
    { name: "Lotus Temple", lat: 28.5535, lng: 77.2588 },
    { name: "Humayun's Tomb", lat: 28.5933, lng: 77.2507 },
    { name: "Red Fort", lat: 28.6562, lng: 77.2410 },
    { name: "India Gate", lat: 28.612894, lng: 77.229446 }, // :contentReference[oaicite:4]{index=4}
    { name: "Jama Masjid", lat: 28.6507, lng: 77.2334 },
    { name: "Qutub Minar", lat: 28.5244, lng: 77.1855 }
  ],
  "Goa": [
    { name: "Basilica of Bom Jesus", lat: 15.5009, lng: 73.9116 },
    { name: "Chapora Fort", lat: 15.6046, lng: 73.7415 },
    { name: "Aguada Fort", lat: 15.4925, lng: 73.7736 },
    { name: "Se Cathedral", lat: 15.5036, lng: 73.9124 },
    { name: "Safa Masjid", lat: 15.4000, lng: 74.0150 },
    { name: "St. Cajetan Church", lat: 15.5107, lng: 73.9120 }
  ],
  "Kerala": [
    { name: "Krishnapuram Palace", lat: 9.1417, lng: 76.4983 },
    { name: "Bekal Fort", lat: 12.3660, lng: 75.0365 },
    { name: "Jewish Synagogue", lat: 9.9633, lng: 76.2790 },
    { name: "Fort Kochi", lat: 9.9656, lng: 76.2425 },
    { name: "Dutch Palace", lat: 9.9651, lng: 76.2596 },
    { name: "Edakkal Caves", lat: 11.6226, lng: 76.2541 }
  ],
  "Rajasthan": [
    { name: "Hawa Mahal", lat: 26.9239, lng: 75.8267 },
    { name: "Jaisalmer Fort", lat: 26.9124, lng: 70.9120 },
    { name: "City Palace of Jaipur", lat: 26.9258, lng: 75.8237 },
    { name: "Jantar Mantar", lat: 26.9248, lng: 75.8246 },
    { name: "Chittorgarh Fort", lat: 24.8887, lng: 74.6551 }
  ],
  "Punjab": [
    { name: "Golden Temple", lat: 31.6200, lng: 74.8765 },
    { name: "Jallianwala Bagh", lat: 31.6205, lng: 74.8769 },
    { name: "Wagah Border", lat: 31.6100, lng: 74.5790 },
    { name: "Lodhi Fort", lat: 30.9120, lng: 75.8480 },
    { name: "Phillaur Fort", lat: 31.0200, lng: 75.7910 }
  ],
  "Karnataka": [
    { name: "Hampi", lat: 15.3350, lng: 76.4600 },
    { name: "Madhukeshwara Temple", lat: 14.4250, lng: 74.5250 },
    { name: "Mysore Palace", lat: 12.3051, lng: 76.6551 },
    { name: "Bidar Fort", lat: 17.9133, lng: 77.5301 },
    { name: "Badami Caves", lat: 15.9149, lng: 75.6768 }
  ],"Jharkhand": [
    { name: "Pahari Mandir", lat: 23.3622, lng: 85.3096 },
    { name: "Jagannath Temple", lat: 23.2966, lng: 85.3126 }
  ],
  "Arunachal Pradesh": [
    { name: "Ita Fort", lat: 27.1000, lng: 93.6200 },
    { name: "Tawang Monastery", lat: 27.5868, lng: 91.8630 },
    { name: "Bomdila Monastery", lat: 27.2520, lng: 92.4010 },
    { name: "Gorsam Chorten", lat: 27.7271, lng: 91.9991 },
    { name: "Golden Pagoda", lat: 27.6734, lng: 96.1598 }
  ],
  "Madhya Pradesh": [
    { name: "Khajuraho", lat: 24.8318, lng: 79.9199 },
    { name: "Gwalior Fort", lat: 26.2309, lng: 78.1734 },
    { name: "Orchha Fort", lat: 25.3500, lng: 78.6400 },
    { name: "Jama Masjid", lat: 22.7179, lng: 75.8333 }
  ],
  "Uttarakhand": [
    { name: "Badrinath", lat: 30.7433, lng: 79.4930 },
    { name: "Jageshwar", lat: 29.6516, lng: 79.5786 },
    { name: "Bageshwar", lat: 29.8373, lng: 79.7696 },
    { name: "Katarmal Sun Temple", lat: 29.6675, lng: 79.6410 }
  ],
  "Himachal Pradesh": [
    { name: "Baijnath Temple", lat: 32.0507, lng: 76.6561 },
    { name: "Kangra Fort", lat: 32.0992, lng: 76.2696 },
    { name: "Champavati Temple", lat: 32.5556, lng: 76.1270 },
    { name: "Tabo Monastery", lat: 32.0965, lng: 78.3841 }
  ],
  "Chhattisgarh": [
    { name: "Ancient Sculpture in Danteswari Temple", lat: 18.8801, lng: 81.3491 },
    { name: "Chandraditya Temple", lat: 21.0800, lng: 81.6230 },
    { name: "Ganesh Statue", lat: 20.2000, lng: 81.2167 },
    { name: "Mama Bhanja Temple", lat: 21.3300, lng: 81.4100 }
  ],
  "West Bengal": [
    { name: "Cooch Behar Palace", lat: 26.3236, lng: 89.4516 },
    { name: "Bishnupur Terracotta Temples", lat: 23.0742, lng: 87.3162 },
    { name: "Hazarduari Palace", lat: 24.1844, lng: 88.2715 },
    { name: "Victoria Memorial", lat: 22.5448, lng: 88.3426 }
  ],
  "Jammu and Kashmir": [
    { name: "Hari Parbat Fort", lat: 34.1006, lng: 74.8091 },
    { name: "Pari Mahal", lat: 34.0854, lng: 74.8444 }
  ],
  "Odisha": [
    { name: "Konark Sun Temple", lat: 19.8876, lng: 86.0945 },
    { name: "Lingaraja Temple", lat: 20.2411, lng: 85.8333 },
    { name: "Jagannath Temple, Puri", lat: 19.8106, lng: 85.8194 },
    { name: "Udayagiri and Khandagiri Caves", lat: 20.2708, lng: 85.7854 },
    { name: "Mukteshwar Temple", lat: 20.2444, lng: 85.8336 }
  ],
  "Gujarat": [
    { name: "Rani ki Vav", lat: 23.8589, lng: 72.1014 },
    { name: "Sun Temple, Modhera", lat: 23.5765, lng: 72.1406 },
    { name: "Dwarkadhish Temple", lat: 22.2394, lng: 68.9670 },
    { name: "Laxmi Vilas Palace", lat: 22.2982, lng: 73.1896 },
    { name: "Adalaj Stepwell", lat: 23.1710, lng: 72.5809 }
  ],
  "Telangana": [
    { name: "Charminar", lat: 17.3616, lng: 78.4747 },
    { name: "Golconda Fort", lat: 17.3833, lng: 78.4011 },
    { name: "Warangal Fort", lat: 17.9754, lng: 79.6011 },
    { name: "Thousand Pillar Temple", lat: 17.9784, lng: 79.5978 },
    { name: "Ramappa Temple", lat: 18.2359, lng: 79.9346 }
  ],
  "Andhra Pradesh": [
    { name: "Amaravati Stupa", lat: 16.5736, lng: 80.3566 },
    { name: "Lepakshi Temple", lat: 13.8077, lng: 77.6038 },
    { name: "Veerabhadra Temple", lat: 13.8084, lng: 77.6051 },
    { name: "Undavalli Caves", lat: 16.4994, lng: 80.6016 },
    { name: "Simhachalam Temple", lat: 17.7795, lng: 83.2624 }
  ],
  "Bihar": [
    { name: "Mahabodhi Temple", lat: 24.6950, lng: 84.9911 },
    { name: "Nalanda University Ruins", lat: 25.1274, lng: 85.4437 },
    { name: "Golghar", lat: 25.6170, lng: 85.1511 },
    { name: "Vikramshila Ruins", lat: 25.3000, lng: 87.3500 },
    { name: "Rohtasgarh Fort", lat: 24.5812, lng: 83.9195 }
  ],
  "Assam": [
    { name: "Kamakhya Temple", lat: 26.1674, lng: 91.7054 },
    { name: "Rang Ghar", lat: 26.9851, lng: 94.6530 },
    { name: "Talatal Ghar", lat: 27.0045, lng: 94.6582 },
    { name: "Umananda Temple", lat: 26.1936, lng: 91.7444 }
  ],"Tamil Nadu": [
    { name: "Brihadishvara Temple", lat: 10.7821, lng: 79.1316 },
    { name: "Mahabalipuram", lat: 12.6212, lng: 80.1945 },
    { name: "Meenakshi Temple", lat: 9.9195, lng: 78.1195 },
    { name: "Thiruvalluvar Statue", lat: 8.0779, lng: 77.5537 }
]
  
 
 
    }

    // Hotel coordinates data
    const hotelCoordinates = {
        "Agra": [
            { name: "The Oberoi Amarvilas", lat: 27.1751, lng: 78.0421, price: "₹25,000/night", rating: 5 },
            { name: "Taj Hotel & Convention Centre", lat: 27.1797, lng: 78.0211, price: "₹12,000/night", rating: 4.5 },
            { name: "Crystal Sarovar Premiere", lat: 27.2025, lng: 78.0233, price: "₹6,000/night", rating: 4 }
        ],
        "Delhi": [
            { name: "The Imperial", lat: 28.6139, lng: 77.2090, price: "₹20,000/night", rating: 5 },
            { name: "The Leela Palace", lat: 28.5922, lng: 77.1855, price: "₹18,000/night", rating: 5 },
            { name: "Taj Palace", lat: 28.6000, lng: 77.1900, price: "₹15,000/night", rating: 4.5 }
        ], "Tamil Nadu": [
        { name: "Taj Fisherman's Cove", lat: 12.7964, lng: 80.2530, price: "₹15,000/night", rating: 5 },
        { name: "The Leela Palace", lat: 13.0025, lng: 80.2550, price: "₹18,500/night", rating: 5 },
        { name: "Sparsa Resort", lat: 8.0871, lng: 77.5465, price: "₹6,200/night", rating: 4 },
        { name: "Ideal Beach Resort", lat: 12.6201, lng: 80.1966, price: "₹7,000/night", rating: 4.5 },
        { name: "Sangam Hotel", lat: 10.7867, lng: 79.1378, price: "₹4,500/night", rating: 4 },
        { name: "Heritage Madurai", lat: 9.9252, lng: 78.1198, price: "₹8,500/night", rating: 4.5 },
        { name: "Sterling Ooty Fern Hill", lat: 11.4064, lng: 76.7031, price: "₹7,500/night", rating: 4 },
        { name: "Great Trails Kodaikanal", lat: 10.2342, lng: 77.4862, price: "₹8,000/night", rating: 4 },
        { name: "Radisson Blu Coimbatore", lat: 11.0168, lng: 76.9558, price: "₹9,500/night", rating: 4.5 },
        { name: "The Residency Towers", lat: 13.0368, lng: 80.2342, price: "₹9,000/night", rating: 4.5 }
    ],
    "Maharashtra": [
        { name: "The Taj Mahal Palace", lat: 18.9216, lng: 72.8331, price: "₹25,000/night", rating: 5 },
        { name: "The Oberoi Mumbai", lat: 18.9265, lng: 72.8213, price: "₹18,000/night", rating: 5 },
        { name: "Vivanta Aurangabad", lat: 19.8641, lng: 75.3251, price: "₹7,500/night", rating: 4 },
        { name: "Radisson Blu Pune", lat: 18.5204, lng: 73.8567, price: "₹8,500/night", rating: 4.5 },
        { name: "Novotel Imagica", lat: 18.7544, lng: 73.3459, price: "₹12,000/night", rating: 4 },
        { name: "The Fern Residency", lat: 21.1498, lng: 79.0806, price: "₹6,500/night", rating: 4 },
        { name: "Le Meridien Mahabaleshwar", lat: 17.9234, lng: 73.6701, price: "₹14,000/night", rating: 4.5 },
        { name: "Radisson Blu Nashik", lat: 19.9975, lng: 73.7898, price: "₹9,500/night", rating: 4.5 },
        { name: "JW Marriott Sahar", lat: 19.1042, lng: 72.8747, price: "₹16,000/night", rating: 5 },
        { name: "The Westin Pune", lat: 18.5642, lng: 73.9155, price: "₹13,500/night", rating: 4.5 }
    ],
    "Rajasthan": [
        { name: "Rambagh Palace", lat: 26.9025, lng: 75.8032, price: "₹35,000/night", rating: 5 },
        { name: "Umaid Bhawan Palace", lat: 26.2816, lng: 73.0483, price: "₹40,000/night", rating: 5 },
        { name: "The Oberoi Udaivilas", lat: 24.5768, lng: 73.6806, price: "₹45,000/night", rating: 5 },
        { name: "Taj Lake Palace", lat: 24.5762, lng: 73.6851, price: "₹50,000/night", rating: 5 },
        { name: "The Leela Palace Jaipur", lat: 26.9124, lng: 75.7873, price: "₹25,000/night", rating: 5 },
        { name: "Alila Fort Bishangarh", lat: 27.1214, lng: 75.6624, price: "₹18,000/night", rating: 4.5 },
        { name: "Samode Haveli", lat: 26.9233, lng: 75.8233, price: "₹12,000/night", rating: 4 },
        { name: "Suryagarh Jaisalmer", lat: 26.9157, lng: 70.9092, price: "₹22,000/night", rating: 5 },
        { name: "Jaisalmer Marriott Resort & Spa", lat: 26.9186, lng: 70.9063, price: "₹14,500/night", rating: 4.5 },
        { name: "Taj Jai Mahal Palace", lat: 26.9115, lng: 75.8023, price: "₹30,000/night", rating: 5 }
    ],"Goa": [
        { name: "Taj Exotica Resort & Spa", lat: 15.2716, lng: 73.9007, price: "₹20,000/night", rating: 5 },
        { name: "The Leela Goa", lat: 15.1552, lng: 73.9440, price: "₹22,500/night", rating: 5 },
        { name: "Grand Hyatt Goa", lat: 15.4634, lng: 73.8417, price: "₹18,000/night", rating: 5 },
        { name: "Radisson Blu Resort", lat: 15.1534, lng: 73.9315, price: "₹10,500/night", rating: 4.5 },
        { name: "Novotel Goa Resort & Spa", lat: 15.5173, lng: 73.7616, price: "₹9,000/night", rating: 4.5 }
    ],
    "Kerala": [
        { name: "Kumarakom Lake Resort", lat: 9.6171, lng: 76.4296, price: "₹15,000/night", rating: 5 },
        { name: "The Leela Kovalam", lat: 8.4021, lng: 76.9783, price: "₹18,500/night", rating: 5 },
        { name: "Taj Bekal Resort & Spa", lat: 12.3928, lng: 75.0484, price: "₹14,000/night", rating: 4.5 },
        { name: "Spice Village", lat: 9.6067, lng: 77.1503, price: "₹7,500/night", rating: 4 },
        { name: "Zuri Kumarakom", lat: 9.6212, lng: 76.4290, price: "₹12,000/night", rating: 4.5 }
    ],
    "Punjab": [
        { name: "Hyatt Regency Amritsar", lat: 31.6424, lng: 74.8754, price: "₹9,000/night", rating: 4.5 },
        { name: "Radisson Blu Hotel Amritsar", lat: 31.7057, lng: 74.7973, price: "₹8,500/night", rating: 4 },
        { name: "Ramada Amritsar", lat: 31.6340, lng: 74.8723, price: "₹7,000/night", rating: 4 },
        { name: "The Oberoi Sukhvilas", lat: 30.8189, lng: 76.7221, price: "₹22,000/night", rating: 5 },
        { name: "Best Western Plus Chandigarh", lat: 30.7415, lng: 76.7746, price: "₹8,000/night", rating: 4 }
    ],
    "Madhya Pradesh": [
        { name: "Jehan Numa Palace", lat: 23.2410, lng: 77.3992, price: "₹12,000/night", rating: 5 },
        { name: "Taj Usha Kiran Palace", lat: 26.2139, lng: 78.1710, price: "₹14,500/night", rating: 5 },
        { name: "Radisson Jabalpur", lat: 23.1815, lng: 79.9864, price: "₹9,500/night", rating: 4.5 },
        { name: "Ahilya Fort Hotel", lat: 22.2394, lng: 75.6022, price: "₹8,500/night", rating: 4 },
        { name: "Clarks Resort Khajuraho", lat: 24.8507, lng: 79.9192, price: "₹7,500/night", rating: 4 }
    ],
    "Karnataka": [
        { name: "Taj West End", lat: 12.9751, lng: 77.5933, price: "₹16,000/night", rating: 5 },
        { name: "The Leela Palace Bengaluru", lat: 12.9601, lng: 77.6489, price: "₹20,000/night", rating: 5 },
        { name: "Evolve Back, Coorg", lat: 12.4052, lng: 75.7400, price: "₹22,000/night", rating: 5 },
        { name: "Radisson Blu Plaza Mysore", lat: 12.3052, lng: 76.6506, price: "₹10,000/night", rating: 4.5 },
        { name: "Golden Landmark Resort", lat: 12.3360, lng: 76.6420, price: "₹8,500/night", rating: 4 }
    ],
    "West Bengal": [
        { name: "The Oberoi Grand Kolkata", lat: 22.5675, lng: 88.3472, price: "₹15,000/night", rating: 5 },
        { name: "ITC Royal Bengal", lat: 22.5595, lng: 88.4125, price: "₹18,000/night", rating: 5 },
        { name: "The Lalit Great Eastern Kolkata", lat: 22.5726, lng: 88.3639, price: "₹12,500/night", rating: 4.5 },
        { name: "Mayfair Darjeeling", lat: 27.0410, lng: 88.2636, price: "₹9,000/night", rating: 4 },
        { name: "Elgin Hotel Darjeeling", lat: 27.0421, lng: 88.2632, price: "₹8,500/night", rating: 4.5 }
    ],
    "Himachal Pradesh": [
        { name: "Wildflower Hall", lat: 31.1230, lng: 77.2675, price: "₹20,000/night", rating: 5 },
        { name: "The Oberoi Cecil", lat: 31.1048, lng: 77.1734, price: "₹18,000/night", rating: 5 },
        { name: "Hotel Willow Banks", lat: 31.1033, lng: 77.1725, price: "₹9,500/night", rating: 4 },
        { name: "Radisson Hotel Shimla", lat: 31.1033, lng: 77.1676, price: "₹10,000/night", rating: 4.5 },
        { name: "Norbu Ghang Resort", lat: 27.2972, lng: 88.6142, price: "₹8,000/night", rating: 4 }
    ],
    "Jammu and Kashmir": [
        { name: "The Khyber Himalayan Resort", lat: 34.0504, lng: 74.3820, price: "₹25,000/night", rating: 5 },
        { name: "Vivanta Dal View", lat: 34.1390, lng: 74.8719, price: "₹18,500/night", rating: 5 },
        { name: "Hotel Heevan Pahalgam", lat: 34.0145, lng: 75.3213, price: "₹12,500/night", rating: 4.5 },
        { name: "Lalit Grand Palace", lat: 34.0901, lng: 74.8473, price: "₹20,000/night", rating: 5 },
        { name: "Radisson Srinagar", lat: 34.0837, lng: 74.7973, price: "₹9,500/night", rating: 4 }
    ]
       
    };

    // Initialize map
    let map;
    let stateMarker;
    let monumentMarkers = [];
    let hotelMarkers = [];

    // Custom icons
    const monumentIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41]
    });

    const hotelIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41]
    });

    function clearMarkers() {
        // Clear monument markers
        monumentMarkers.forEach(marker => map.removeLayer(marker));
        monumentMarkers = [];

        // Clear hotel markers
        hotelMarkers.forEach(marker => map.removeLayer(marker));
        hotelMarkers = [];

        // Clear state marker
        if (stateMarker) {
            map.removeLayer(stateMarker);
            stateMarker = null;
        }
    }

    function addMonumentMarkers(state) {
        if (monumentCoordinates[state]) {
            monumentCoordinates[state].forEach(monument => {
                const marker = L.marker([monument.lat, monument.lng], { icon: monumentIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="monument-popup">
                            <h4>${monument.name}</h4>
                            <p>Historical Monument</p>
                        </div>
                    `);
                monumentMarkers.push(marker);
            });
        }
    }

    function addHotelMarkers(state) {
        if (hotelCoordinates[state]) {
            hotelCoordinates[state].forEach(hotel => {
                const marker = L.marker([hotel.lat, hotel.lng], { icon: hotelIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="hotel-popup">
                            <h4>${hotel.name}</h4>
                            <p>Price: ${hotel.price}</p>
                            <p>Rating: ${'⭐'.repeat(hotel.rating)}</p>
                        </div>
                    `);
                hotelMarkers.push(marker);
            });
        }
    }

    function initMap() {
        // Create map centered on India
        map = L.map('map').setView([20.5937, 78.9629], 5);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add legend
        const legend = L.control({ position: 'topright' });
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = `
                <div class="legend-item">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" class="legend-icon">
                    <span>Historical Monuments</span>
                </div>
                <div class="legend-item">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" class="legend-icon">
                    <span>Hotels</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        // Add state selection event listener
        document.getElementById('stateSelect').addEventListener('change', function() {
            const selectedState = this.value;
            if (selectedState && stateCoordinates[selectedState]) {
                const coords = stateCoordinates[selectedState];
                
                // Clear all existing markers
                clearMarkers();

                // Add state marker
                stateMarker = L.marker([coords.lat, coords.lng])
                    .addTo(map)
                    .bindPopup(selectedState);

                // Add monument and hotel markers
                addMonumentMarkers(selectedState);
                addHotelMarkers(selectedState);

                // Fly to the selected state
                map.flyTo([coords.lat, coords.lng], coords.zoom, {
                    duration: 2,
                    easeLinearity: 0.25
                });
            }
        });
    }

    // Initialize map when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>

<style>
    /* Update map container styles */
    .map-frame {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        margin-bottom: 15px;
        z-index: 1;
    }

    /* Ensure map container has proper z-index */
    .map-container {
        position: relative;
        z-index: 1;
    }

    /* Popup styles */
    .monument-popup h4,
    .hotel-popup h4 {
        color: #f1683a;
        margin: 0 0 5px 0;
        font-size: 16px;
    }

    .monument-popup p,
    .hotel-popup p {
        margin: 5px 0;
        font-size: 14px;
        color: #666;
    }

    /* Legend styles */
    .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }

    .legend-icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
    }

    /* Add legend to map */
    .leaflet-control-container .leaflet-top.leaflet-right {
        z-index: 1000;
    }
</style>

<!-- Add this before the closing </div> of the container -->
<!-- Booking Summary Modal -->
<div class="modal fade" id="bookingSummaryModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Booking Summary</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="booking-summary">
                    <div class="summary-section">
                        <h6>Monument Details</h6>
                        <p><strong>Monument:</strong> <span id="summaryMonument"></span></p>
                        <p><strong>Visit Date:</strong> <span id="summaryVisitDate"></span></p>
                        <p><strong>Number of Visitors:</strong> <span id="summaryVisitors"></span></p>
                    </div>
                    <div class="summary-section">
                        <h6>Personal Information</h6>
                        <p><strong>Name:</strong> <span id="summaryName"></span></p>
                        <p><strong>Email:</strong> <span id="summaryEmail"></span></p>
                        <p><strong>Phone:</strong> <span id="summaryPhone"></span></p>
                    </div>
                    <div class="summary-section">
                        <h6>Payment Details</h6>
                        <p><strong>Total Amount:</strong> <span id="summaryAmount"></span></p>
                        <p><strong>Payment Method:</strong> <span id="summaryPaymentMethod"></span></p>
                        <p><strong>Transaction ID:</strong> <span id="summaryTransactionId"></span></p>
                    </div>
                    <div class="summary-section">
                        <h6>Uploaded Documents</h6>
                        <div id="summaryDocuments" class="document-list"></div>
                    </div>
                    <div class="summary-section">
                        <h6>Special Requests</h6>
                        <p id="summarySpecialRequests"></p>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="downloadTicket()">
                        <i class="fas fa-download"></i> Download Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.booking-summary {
    padding: 20px;
}

.summary-section {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.summary-section h6 {
    color: #f1683a;
    margin-bottom: 15px;
    font-weight: 600;
}

.summary-section p {
    margin-bottom: 8px;
}

.document-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.document-item {
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 8px;
}

.document-item i {
    color: #f1683a;
}
</style>

<script>
// ... existing code ...

// Add this function to show the booking summary
function showBookingSummary(bookingData) {
    document.getElementById('summaryMonument').textContent = bookingData.monument;
    document.getElementById('summaryVisitDate').textContent = bookingData.visit_date;
    document.getElementById('summaryVisitors').textContent = bookingData.visitors;
    document.getElementById('summaryName').textContent = bookingData.name;
    document.getElementById('summaryEmail').textContent = bookingData.email;
    document.getElementById('summaryPhone').textContent = bookingData.phone;
    document.getElementById('summaryAmount').textContent = `₹${bookingData.amount}`;
    document.getElementById('summaryPaymentMethod').textContent = bookingData.payment_method;
    document.getElementById('summaryTransactionId').textContent = bookingData.transaction_id;
    
    // Handle documents
    const documentsDiv = document.getElementById('summaryDocuments');
    documentsDiv.innerHTML = '';
    if (bookingData.documents && bookingData.documents.length > 0) {
        bookingData.documents.forEach(doc => {
            documentsDiv.innerHTML += `
                <div class="document-item">
                    <i class="fas fa-file-alt"></i>
                    <span>${doc.name}</span>
                </div>
            `;
        });
    } else {
        documentsDiv.innerHTML = '<p>No documents uploaded</p>';
    }
    
    // Handle special requests
    const specialRequests = document.getElementById('summarySpecialRequests');
    specialRequests.textContent = bookingData.special_requests || 'No special requests';
    
    // Show the modal
    $('#bookingSummaryModal').modal('show');
}

// Modify the existing payment success handler to show the summary
function handlePaymentSuccess(data) {
    // ... existing success handling code ...
    
    // Show booking summary
    showBookingSummary({
        monument: document.getElementById('monument').value,
        visit_date: document.getElementById('visit_date').value,
        visitors: document.getElementById('visitors').value,
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        amount: document.getElementById('total_amount').value,
        payment_method: document.getElementById('payment_method').value,
        transaction_id: data.transaction_id,
        documents: Array.from(document.getElementById('documents').files).map(file => ({
            name: file.name
        })),
        special_requests: document.getElementById('special_requests').value
    });
}

// Add ticket download functionality
function downloadTicket() {
    // Generate a fake QR code
    const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ITIHASA-${Date.now()}`;
    
    // Create ticket content
    const ticketContent = `
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 style="color: #f1683a;">ITIHASA</h1>
                <h2>Entry Ticket</h2>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="${qrCode}" alt="QR Code" style="width: 150px; height: 150px;">
            </div>
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;">
                <p><strong>Monument:</strong> ${document.getElementById('summaryMonument').textContent}</p>
                <p><strong>Visit Date:</strong> ${document.getElementById('summaryVisitDate').textContent}</p>
                <p><strong>Number of Visitors:</strong> ${document.getElementById('summaryVisitors').textContent}</p>
                <p><strong>Name:</strong> ${document.getElementById('summaryName').textContent}</p>
                <p><strong>Transaction ID:</strong> ${document.getElementById('summaryTransactionId').textContent}</p>
            </div>
            <div style="text-align: center; font-size: 12px; color: #666;">
                <p>This is a valid ticket for entry to the monument.</p>
                <p>Please present this ticket at the entrance.</p>
            </div>
        </div>
    `;
    
    // Create a new window and print the ticket
    const printWindow = window.open('', '_blank');
    printWindow.document.write(ticketContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

document.addEventListener('DOMContentLoaded', function() {
    const packageSelect = document.getElementById('tourPackage');
    const packageMessage = document.createElement('div');
    packageMessage.className = 'alert alert-success mt-2';
    packageMessage.style.display = 'none';
    packageSelect.parentNode.appendChild(packageMessage);

    // Add hidden input for total amount
    const totalAmountInput = document.createElement('input');
    totalAmountInput.type = 'hidden';
    totalAmountInput.id = 'total_amount';
    totalAmountInput.name = 'total_amount';
    document.getElementById('bookingForm').appendChild(totalAmountInput);

    // Function to generate random amount between 100 and 1000
    function generateRandomAmount() {
        return Math.floor(Math.random() * 901) + 100; // Random number between 100 and 1000
    }

    // Function to update all payment amounts
    function updatePaymentAmounts(amount) {
        const formattedAmount = Math.round(amount); // Ensure whole number
        document.getElementById('card-payment-amount').textContent = formattedAmount;
        document.getElementById('upi-payment-amount').textContent = formattedAmount;
        totalAmountInput.value = formattedAmount;
        
        // Also update any other elements that show the amount
        document.querySelectorAll('.payment-amount').forEach(el => {
            el.textContent = formattedAmount;
        });
    }

    // Function to update package options
    function updatePackageOptions(packages) {
        packageSelect.innerHTML = '<option value="">Select a Package</option>';
        packages.forEach(package => {
            const option = document.createElement('option');
            option.value = package.id;
            // Extract price from the package name if it contains it
            const priceMatch = package.name.match(/₹(\d+)/);
            const price = priceMatch ? parseFloat(priceMatch[1]) : package.price;
            option.textContent = `${package.name} - ${package.duration}`;
            option.setAttribute('data-price', price);
            packageSelect.appendChild(option);
        });
    }

    // Fetch tour packages when the page loads
    fetch('/api/get-tour-packages')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.packages) {
                const allPackages = [];
                Object.values(data.packages).forEach(statePackages => {
                    allPackages.push(...statePackages);
                });
                updatePackageOptions(allPackages);
            } else {
                console.error('Invalid package data received:', data);
            }
        })
        .catch(error => console.error('Error fetching packages:', error));

    packageSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
            // Extract price from the selected option text if it contains it
            const priceMatch = selectedOption.textContent.match(/₹(\d+)/);
            const price = priceMatch ? 
                         parseFloat(priceMatch[1]) : 
                         parseFloat(selectedOption.getAttribute('data-price'));
            
            if (!isNaN(price)) {
                packageMessage.textContent = `Selected Package: ${selectedOption.text} - Price: ₹${price}`;
                packageMessage.style.display = 'block';
                updatePaymentAmounts(price);
            } else {
                console.error('Invalid package price:', selectedOption.textContent);
                packageMessage.style.display = 'none';
            }
        } else {
            packageMessage.style.display = 'none';
            const randomAmount = generateRandomAmount();
            updatePaymentAmounts(randomAmount);
        }
    });

    // Function to update all payment amounts
    function updatePaymentAmounts(amount) {
        const formattedAmount = Math.round(amount); // Ensure whole number
        document.getElementById('card-payment-amount').textContent = formattedAmount;
        document.getElementById('upi-payment-amount').textContent = formattedAmount;
        totalAmountInput.value = formattedAmount;
        
        // Also update any other elements that show the amount
        document.querySelectorAll('.payment-amount').forEach(el => {
            el.textContent = formattedAmount;
        });
    }

    // Set initial random amount if no package is selected
    if (!packageSelect.value) {
        const randomAmount = generateRandomAmount();
        updatePaymentAmounts(randomAmount);
    }
});

function loadPackages() {
    fetch('/guide/get-packages')
        .then(response => response.json())
        .then(data => {
            const packageGrid = document.getElementById('packageGrid');
            packageGrid.innerHTML = '';
            
            data.packages.forEach(package => {
                // Use the template above with package data
                const packageHTML = `... template with package data ...`;
                packageGrid.innerHTML += packageHTML;
            });
        });
}

function loadAvailablePackages() {
    fetch('/api/get-tour-packages')
        .then(response => response.json())
        .then(data => {
            const packagesContainer = document.getElementById('availablePackages');
            packagesContainer.innerHTML = '';
            
            data.packages.forEach(package => {
                // Use the template above with package data
                const packageHTML = `... template with package data ...`;
                packagesContainer.innerHTML += packageHTML;
            });
        });
}
</script>
// ... existing code ...
{% endblock %} 